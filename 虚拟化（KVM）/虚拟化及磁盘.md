虚拟机，我们常叫做实例。一个实例就含一个最基本的服务器的最小系统，包括虚拟硬件系统和软件系统。

通常生产环节的服务器不适用GUI界面，但是再做KVM的时候，需要GUI界面做辅助管理，所以再安装KVM之前务必先安装桌面。

**KVM最终生成的配置文件是xml文件**

创建虚拟机时，使用命令```virt-install```创建KVM虚拟机。

常用参数：

* name：虚拟机名
* vCPUs：虚拟CPU核心数
* ram：虚拟内存大小
* os-type：系统类型
* cdrom：CD挂载的镜像文件
* file：虚拟机硬盘文件
* file-size：虚拟硬盘大小

# 虚拟硬盘

通常情况，任何电脑想运行起来都得有硬盘做数据存储支持，所以，咱们先创建虚拟硬盘：

```
qemu-img create xxx.qcow2 -f qcow2 size
```

上述代码创建了一个qcow2格式的虚拟硬盘。

虚拟磁盘大概有两种类型，一个是IDE，一个是Virtio。根据读写数据测试，Virtio是性能最好的方案。

虚拟磁盘的格式也有很多种，用的最多的是qcow2格式的硬盘文件。

QEMU支持常见使用的raw和qcow2格式。

# 硬盘虚拟化的主要操作

## 硬盘创建

```
qemu-img create test 50G
```
创建一个50G的硬盘，但是没有写是什么格式。要实际使用必须给一个指定的硬盘格式。

```
qemu-img create test.qcow2 -f qcow2 50G
```

上边就是指定生成一个qcow2格式的硬盘。注意钱两段语句test有无后缀。

这里不写绝对地址，那么就再当前目录生成文件。

可以通过```qemu-img info test.qcow2```查看生成硬盘的信息。

## 硬盘格式转换

平时硬盘也就一两种格式常用，但是有时候也会使用其他格式，那么就需要进行转换。

```
qemu-img convert -p -f raw -O qcow2 test test1.qcow2
```
#快照

快照就是系统在某一个瞬间被“抓拍”到的状态，这个状态可以随时进行恢复。

```
qemu-img snapshot test.qcow2 -c s1
```
以上代码创建了一个名为s1的快照，我们可以查看一下快照列表：

```
qemu-img snapshot test.qcow2 -l
```

镜像是用来给特殊情况下给服务器做还原用的，所以必然就会用到还原，使用a参数

```
qemu-img snapshot test.qcow2 -a s1
```
# 后备镜像

后备镜像就是常说的公有镜像，一个后备镜像可以做多个虚拟机的母盘。

后备（backend）使用：

```
qemu-img create -f qcow2 -b backend img_name
```

使用后备磁盘创建一个虚拟硬盘。


# 虚拟硬盘属性定义

最常用的硬盘指标是容量，虚拟主机经常会出现硬盘不足，那么我们就需要手动再给加大硬盘了。

```
qemu-img resize test1.qcow2 +2G
```

这里是给元硬盘的基础加2G，当然也可以写成需要改到的大小。

# 裸设备

为让虚拟机获取极致的算力和性能，可以直接挂在裸硬盘到虚拟机。也可以使用lvm，但是lvm需要关闭cache，防止数据丢失。

# 常用虚拟硬盘格式对比

RAW：整体性能较高

qcow2：常见的虚拟硬盘格式，适合高消耗计算

lvm：适合高IO的计算